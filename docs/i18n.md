# Normalización de textos y soporte para caracteres acentuados

Para garantizar resultados consistentes al indexar y consultar documentos en múltiples idiomas, las cadenas de texto se normalizan utilizando **NFC (Normalization Form Canonical Composition)**.

- **Ingesta**: Antes de guardar los fragmentos en Chroma, se normaliza el contenido y se conserva el texto original dentro de la metadata (`original_page_content`). Esto evita discrepancias entre grafemas combinados y precompuestos, manteniendo la trazabilidad del texto tal como fue cargado.
- **Consultas**: Las preguntas de los usuarios se normalizan con el mismo criterio antes de aplicar validaciones o enviarlas al motor de recuperación. Con ello aseguramos comparaciones consistentes, especialmente cuando se introducen caracteres combinados desde distintos teclados o sistemas operativos.

Esta estrategia respeta las diferencias semánticas entre palabras acentuadas y no acentuadas (por ejemplo, `café` frente a `cafe`), al tiempo que evita que variaciones en la representación Unicode afecten la búsqueda o la generación de respuestas.

## Detección de idioma en consultas

Para seleccionar la plantilla de mensajes y las respuestas en el idioma correcto se utiliza la librería [``langdetect``](https://pypi.org/project/langdetect/). Antes de invocar el modelo se analiza el texto original (tras normalizarlo a NFC) con la función `detect_language`, que devuelve códigos `es` o `en`.

- Cuando el usuario no especifica idioma, `response()` emplea el resultado de `detect_language` como valor por defecto.
- La detección se refuerza con una heurística ligera que prioriza español cuando la cadena contiene tildes (`á`, `é`, `í`, etc.), signos de interrogación/exclamación invertidos (`¿`, `¡`) o saludos frecuentes (`hola`, `gracias`, `buenos/buenas`). Esto evita que los acentos se pierdan al normalizar y reduce falsos positivos hacia inglés en frases mixtas.
- Si el detector devuelve un idioma no soportado o no se puede determinar con confianza, el sistema cae de nuevo a español para mantener la compatibilidad con el comportamiento anterior.

De esta forma se mantienen las tildes originales del usuario y se ofrece una experiencia bilingüe más consistente sin introducir dependencias pesadas.
